---
title: "R Notebook"
output: html_notebook
---




```{r, message=FALSE, warning=FALSE}
require(csDEX)
require(DEXSeq)
data.dir = "/Users/martin/Desktop/csdex-temp/"
```


```{r}
dispersion.csdex <- function(obj){
  cdx = obj$data
  cdx = csDEX::estimateSizeFactors(cdx)
  cdx = csDEX::estimatePrecisions(cdx)
  disp = 1.0 / csDEX::rowData(cdx)$precision
  return(disp)
}
```

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Cmd+Shift+Enter*. 


```{r}
dispersion.dexseq <- function(obj){
    sampleData = obj$design
    countfiles = file.path(obj$data.dir, "data", paste0(sampleData$File.accession, ".txt"))
    dex = DEXSeqDataSetFromHTSeq(
      countfiles = countfiles,
      sampleData = sampleData)
    dex = DEXSeq::estimateSizeFactors(dex)
    dex = DEXSeq::estimateDispersions(dex)
    disp = dispersions(dex)
    return(disp)
}
```


Let's generate a fixed vector of precisions.

```{r, message=FALSE, warning=FALSE}
features = 20
# dispersions = 1.0/runif(features, 0.1, 20)  # Dispersions mus span multiple orders of magnitude
dispersions = rgamma(features, 1, 2)
dispersions = dispersions[order(dispersions)]
conditions = c(3, 5, 10)
repeats = 5
conditions = 10 # Large number of conditions is essential for the fit to work

est.cdx = matrix(0, nrow=repeats, ncol=features)
est.dex = matrix(0, nrow=repeats, ncol=features)
for (r in 1:repeats){
  obj = generate(exons=features, conditions=conditions, 
                   interacting=0, replicates=2, genes=1, 
                   dispersions = dispersions,
                   type="count", data.dir=data.dir, seed=NULL)
  
  est.cdx[r,] = dispersion.csdex(obj)
  est.dex[r,] = dispersion.dexseq(obj)
}


# Plot the fits
x = 1:features
mean.cdx = colMeans(est.cdx)
std.cdx = apply(est.cdx, 2, sd)
down.cdx = mean.cdx + std.cdx
up.cdx = mean.cdx - std.cdx

mean.dex = colMeans(est.dex)
std.dex = apply(est.dex, 2, sd)
down.dex = mean.dex + std.dex
up.dex = mean.dex - std.dex

inxs = rev(order(obj$precisions))
plot(dispersions, type="l", col="black", xlab="Exon", ylab="Dispersion")
lines(mean.cdx, col="orange")
lines(mean.dex, col="blue")
polygon(c(x, rev(x)), c(up.cdx, rev(down.cdx)), col=rgb(1,0,0,0.2), border=NA)
polygon(c(x, rev(x)), c(up.dex, rev(down.dex)), col=rgb(0,0,1,0.2), border=NA)
```

